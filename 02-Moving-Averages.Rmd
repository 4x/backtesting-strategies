# Moving Averages

## What are Moving Averages

Moving Averages are technical indicators reflecting either an average or weighted average of the last $n$ prices:

$$ SMA(n) = \frac{Cl_1 + Cl_2 + Cl_3\dots + Cl_n}{n} $$

So, if $n$ were 20 we would take the sum of $Cl$ from the last observation, $Cl_1$, to the 20th observation, $Cl_{20}$, and divide that sum by $n$. This gives us a dyanamic price level that can give a broader indication of the overall price trend. This would be represented on the legend of price charts as **SMA(20)**.                    

Many technical analysts will look at **SMA(20)** as a quick reference to the broader scope of the price action. A **SMA(20)** with a positive slope would suggests the overall price action is in an uptrend. A flattened **SMA(20)** would suggest indecision by the market. And a negative slope would suggest a bearish trend. 

Some times swing traders will make decisions on how price action behaves around the **SMA(20)**. For example, if intraday price action breaks below a positive-slope **SMA(20)** but manages to close above, this could suggest the indicator is acting as a level of support. This can occur quite often in strong uptrends. You place a *MOC* (Market-On-Close) or *MOO* (Market-On-Open) order for the next day as long as price is above the **SMA(20)**. The sell signal is clearly defined if $Cl$ is lower than **SMA(20)**.      

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = TRUE, 
                      include = TRUE, cache = TRUE)
```

```{r libraries}
library(dplyr)
library(ggplot2)
library(lattice)
library(tidyr)
library(TTR)
```

## Close/SMA(20) Crossover

```{r 2.1-settings}
strategy_title <- "Close > SMA(20)"
```

$$ Signal = 
    \begin{cases} 
        Cl >= SMA(20), BTO \\ 
        Cl < SMA(20), STC 
    \end{cases}
$$

```{r 2.1-initialize-portfolio}
Cl.SMA20.Crossover <- "Cl.Sma20.Crossover"
rm.strat(Cl.SMA20.Crossover)
initPortf(Cl.SMA20.Crossover, symbols = symbols, initDate = pv$init_date)
initAcct(Cl.SMA20.Crossover, portfolios = Cl.SMA20.Crossover, 
         initDate = pv$init_date, initEq = pv$account_equity)
initOrders(portfolio = Cl.SMA20.Crossover, initDate = pv$init_date)
strategy(Cl.SMA20.Crossover, store = TRUE)
strat <- getStrategy(Cl.SMA20.Crossover)
```

```{r 2.1-add-indicators}
add.indicator(strategy = Cl.SMA20.Crossover, name = "SMA", 
              arguments = list(x = quote(Cl(mktdata)), n = 20), label = "SMA20")
```

```{r 2.1-add-signals}
add.signal(Cl.SMA20.Crossover, name="sigCrossover", 
           arguments = list(columns = c("Close", "SMA20"), relationship = "gte"),
           label="Cl.gte.SMA")
add.signal(Cl.SMA20.Crossover, name = "sigCrossover",
           arguments = list(columns = c("Close", "SMA20"), relationship = "lt"),
           label = "Cl.lt.SMA")
```

```{r 2.1-add-rules}
# BTO when Cl crosses above SMA(20)
add.rule(Cl.SMA20.Crossover, name = 'ruleSignal',
         arguments = list(sigcol = "Cl.gte.SMA", sigval = TRUE, orderqty = 100,
                          ordertype = 'market', orderside = 'long'),
         type = 'enter')

# STC when Cl crosses under SMA(20)
add.rule(Cl.SMA20.Crossover, name = 'ruleSignal',
         arguments = list(sigcol = "Cl.lt.SMA", sigval = TRUE, orderqty = 'all',
                          ordertype = 'market', orderside = 'long'),
         type = 'exit')
```

```{r 2.1-apply-strategy, include = FALSE }
applyStrategy(strategy = Cl.SMA20.Crossover, portfolios = Cl.SMA20.Crossover)
```

```{r 2.1-update-portfolio}
updatePortf(Cl.SMA20.Crossover)
updateAcct(Cl.SMA20.Crossover)
updateEndEq(Cl.SMA20.Crossover)
```

```{r 2.1-account-summary}
a <- getAccount(Cl.SMA20.Crossover)
p <- getPortfolio(Cl.SMA20.Crossover)
```

```{r 2.1-individual-asset-returns}
rets.multi <- PortfReturns(Cl.SMA20.Crossover)
colnames(rets.multi) <- symbols
rets.multi <- na.omit(cbind(rets.multi, Return.calculate(a$summary$End.Eq)))
names(rets.multi)[length(names(rets.multi))] <- "TOTAL"
rets.multi <- rets.multi[,c("TOTAL", symbols)]
```

```{r 2.1-cumulative-returns, fig.cap = "Cumulative Returns by Asset"}
chart.CumReturns(rets.multi, colorset = rich10equal, 
                 main = "Cumulative Returns")
```

```{r 2.1-return-distribution-analysis, fig.cap = "Return Distribution Analysis"}
chart.Boxplot(rets.multi, main = "Returns", colorset = rich10equal)
```

```{r 2.1-annualized-risk-return, fig.cap = "Annualized Risk and Return"}
(ar.tab <- table.AnnualizedReturns(rets.multi))
(max.risk <- max(ar.tab["Annualized Std Dev",]))
(max.return <- max(ar.tab["Annualized Return",]))
chart.RiskReturnScatter(rets.multi, main = "Performance", 
                        colorset = rich10equal, xlim = c(0, max.risk * 1.1), 
                        ylim = c(0, max.return))
```

```{r 2.1-consolidated-equity-curve, fig.cap = "Consolidated Equity Curve"}
equity <- a$summary$End.Eq
plot(equity, main = "Consolidated Equity Curve")
```

```{r 2.1-mae}
for(symbol in symbols) {
    chart.ME(Portfolio = Cl.SMA20.Crossover, Symbol = symbol, type = "MAE", 
             scale = "percent")
}
```

```{r 2.1-mfe}
for(symbol in symbols) {
    chart.ME(Portfolio = Cl.SMA20.Crossover, Symbol = symbol, type = "MFE", 
             scale = "percent")
}
```

```{r}
a <- getAccount(Cl.SMA20.Crossover)
xyplot(a$summary, type = "h", col = 4)
equity <- a$summary$End.Eq
plot(equity, main = strategy_title)
ret <- Return.calculate(equity, method = "log")
charts.PerformanceSummary(ret, colorset = bluefocus, 
                          main = strategy_title)
```

## Close/SMA(20) Crossunder

## Golden Cross

$$ Signal = 
    \begin{cases} 
        SMA(50) \text{Crossover} SMA(100), BTO \\ 
        SMA(50) \text{Crossunder} SMA(100), STC 
    \end{cases}
$$
